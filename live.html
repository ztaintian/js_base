@{
var apiHost = CIIC.Common.Configuration.ConfigurationHelper.GetConfigValue<string>("HTApiUrl");
  }

  <link rel="stylesheet" type="text/css" href="~/Content/OCTTemplet/mob/Style/Live/Live1.css?v=3" />
  <link href="~/Scripts/videojs7/video-js.min.css" rel="stylesheet" />
  <link href="~/Content/CZ/CSS/CZ.css" rel="stylesheet" type="text/css">
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    #liveplayer {
      width: 100%;
      height: 9rem;
    }

    .top {
      background: #fff;
      padding: 0.5rem 0.6rem;
      font-size: 0.6rem;
      border-bottom: 1px solid #eee;
    }

    .top-title {
      display: flex;
      background: #fff;
      align-items: center;
    }

    .p2 {
      width: 2.56rem;
      height: 1.28rem;
      line-height: 1.28rem;
      text-align: center;
      border: 1px solid #eee;
      border-radius: 0.64rem;
      margin-left: 0.5rem;
    }

    .p2-active {
      background: #3A78E9;
      color: #fff;
    }

    .top-title .p1 {
      color: #000;
      font-weight: bold;
      overflow: hidden;
      display: -webkit-box;
      text-overflow: ellipsis;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      flex: 1;
    }

    .top-time {
      margin-top: 0.5rem;
      display: flex;
      justify-content: space-between;
    }

    .start-time {
      height: 1.1rem;
      line-height: 1.1rem;
      width: 7.26rem;
      font-size: 0.5rem;
      border: 1px solid #3E7AE9;
      color: #3E7AE9;
      text-align: center;
      border-radius: 0.5rem;
      margin-left: 0.5rem;
    }

    .room {
      padding: 0.2rem 0;
      color: #969696;
    }

    .middle {
      margin: 0.34rem 0 0.47rem;
      background: #fff;
      height: 2.05rem;
      overflow: hidden;
    }

    .hot-img {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.5rem;
      margin-right: 0.8rem;
    }

    .hot-img span {
      color: #6EABF9;
    }

    .img-css {
      height: 1rem;
      weight: 1rem;
    }

    .right {
      display: flex;
      float: right;
      margin-top: 0.2rem;
    }

    #brief {
      margin-left: 0.8rem;
    }

    .brief-introduction {
      float: left;
      line-height: 1.9rem;
      display: inline-block;
      font-size: 0.6rem;
      width: 3.2rem;
      color: #3E7AE9;
      text-align: center;
    }

    .active-border {
      border-bottom: 0.09rem solid #3E7AE9;
    }

    .mtR1 {
      margin-right: 1rem;
    }

    .article-padding {
      width: 15.19rem;
      margin: 0 auto;
      overflow: auto;
      background: #fff;

    }

    .article {
      font-size: 0.5rem;
      padding: 0 0.2rem;
    }

    .article-title {
      font-size: 0.8rem;
      padding: 0 0.5rem;
      line-height: 2rem;
      font-weight: bold;
      border-bottom: 1px solid #eee;
    }

    .article-text {
      padding: 0.5rem;
      line-height: 1rem;
    }

    .talk_input {
      display: flex;
      width: 100%;
      position: absolute;
      bottom: 0;
      justify-content: center;
      align-items: center;
      height: 2.34rem;
      background: #E5E5E5;
    }

    .talk_word {
      height: 1.5rem;
      width: 11.33rem;
      padding: 0px;
      outline: none;
      border: none;
      font-size: 0.6rem;
      border-radius: 0.75rem;
      text-align: center;
    }



    .talk_show {
      width: 100%;
      overflow: auto;
      box-sizing: border-box;
      font-size: 0.6rem;
      padding: 0 0 3rem 0;
    }

    .talk_sub {
      height: 1.5rem;
      width: 2.84rem;
      float: left;
      outline: none;
      border: none;
      background: #4DE9C9;
      color: #fff;
      border-radius: 0.75rem;
      font-size: 0.6rem;
      margin-left: 0.4rem;
    }

    .talk_con {
      width: 100%;
    }

    .atalk {
      margin: 0.2rem;
      padding-left: 0.8rem;
    }

    .talk-name {
      display: block;
      margin: 0.4rem 0 0.2rem;
      color: #3D8CE9;
    }

    .atalk .content {
      display: inline-block;
      background: #fff;
      border-radius: 0 0.64rem 0.64rem 0.85rem;
      color: #000;
      line-height: 1.45rem;
      padding: 0 1rem 0 0.42rem;
    }

    .btalk {
      margin: 0.2rem;
      padding-right: 0.8rem;
      text-align: right;
    }

    .btalk .content {
      display: inline-block;
      background: #fff;
      border-radius: 0.64rem 0 0.85rem 0.64rem;
      color: #000;
      line-height: 1.45rem;
      padding: 0 0.42rem 0 1rem;
    }

    .display-none {
      display: none;
    }

    .img-icon1 {
      width: 0.6rem;
      height: 0.6rem;
      align-self: flex-start;
      margin-top: 0.2rem;
    }

    .video-js .vjs-big-play-button {
      /* 中间大的播放按钮 */
      height: 2em;
      width: 2em;
      border: none;
      margin-left: -1em;
      border-radius: 50%;
      background: url(/Content/images/resume/play.png) no-repeat;
      background-size: contain;
      background-color: transparent;
    }

    .video-js .vjs-big-play-button:after {
      content: "";
    }

    .video-js .vjs-big-play-button .vjs-icon-placeholder:before,
    .vjs-icon-play:before {
      content: "";
    }

    .video-js.vjs-paused .vjs-big-play-button {
      /* 视频暂停时显示播放按钮 */
      display: block;
    }

    .video-js.vjs-error .vjs-big-play-button {
      /* 视频加载出错时隐藏播放按钮 */
      display: none;
    }

    .vjs-loading-spinner {
      /* 加载圆圈 */
      font-size: 2.5em;
      width: 2em;
      height: 2em;
      border-radius: 1em;
      margin-top: -1em;
      margin-left: -1.5em;
    }

    .notice {
      background: #fff;
      display: flex;
      font-size: 0.6rem;
      width: 14rem;
      margin: 0 auto;
      height: 2.27rem;
      border-radius: 0.4rem;
      padding: 0.36rem;
      position: absolute;
      overflow: hidden;
      left: 50%;
      transform: translate(-50%, 0);
    }

    .notice .img-notice {
      width: 0.77rem;
      height: 0.77rem;
      margin-right: 0.2rem;
    }

    .notice .content {
      color: #9B9B9B;
      flex: 1;
      vertical-align: middle;
    }

    .notice .text {
      color: #428FEA;
    }

    .video-js.vjs-playing .vjs-tech {
      pointer-events: auto;
    }

    .notice .close {
      color: #63D497;
      font-size: 0.5rem;
      float: right;
    }

    .notice .speaker {
      color: #63D497;
      font-size: 0.8rem;
      vertical-align: middle;
    }

    #chat-box {
      margin-top: 3.2rem;
    }

    .video-js .vjs-fullscreen-control {
      right: 0;
      position: absolute;
    }

    .play {
      color: #63D497;
      font-size: 0.8rem;
    }
  </style>
  <div id="getHeight">
    <!-- <div style="height:2rem;"></div> -->
    <video id="liveplayer" webkit-playsinline="true" playsinline="true"
      class="video-js vjs-big-play-centered vjs-default-skin">
      <p class="vjs-no-js">
        To view this video please enable JavaScript, and consider upgrading to a
        web browser that
        <a href="https://videojs.com/html5-video-support/" target="_blank">
          supports HTML5 video
        </a>
      </p>
    </video>
    <div class="middle">
      <span class="brief-introduction active-border" id="brief">简介</span>
      <span class="brief-introduction" id="interaction">互动</span>
      <div class="right">
        <span class="hot-img" id="hotBox">
          <img class="img-css" src="~/Content/images/resume/icon1.png" />
          <span id="hot"></span>
        </span>
        <span class="hot-img" id="addlike">
          <img class="img-css" src="~/Content/images/resume/icon2.png" />
          <span id="like"></span>
        </span>
        <span class="hot-img" id="share">
          <img class="img-css" src="~/Content/images/resume/icon3.png" />
          <span id="forword"></span>
        </span>
      </div>
    </div>
  </div>
  <div class="article-padding">
    <div class="top">
      <div class="top-title">
        <!-- <img class="img-icon1" src="~/Content/images/resume/play.png"  /> -->
        <i class="iconfont play">&#xe6ef;</i>
        <p class="p1" id="title">
        <p>
        <p id="LiveStatus" class="p2 p2-active"></p>
      </div>
      <div class="top-time">
        <p class="start-time">开播时间：<span id="time"></span></p>
        <p class="room">房间号：<span id="room-num"></span></p>
      </div>
    </div>

    <div class="article">
      <p class="article-text"></p>
      <a id="aHref">
        <img id="imgId" style="width:90%;margin-left:5%;" src="" />
      </a>
      <p id="footId" style="padding: 0.5rem;line-height:1rem;">fafafafaf</p>
    </div>
  </div>
  <div class="talk_con display-none">
    <div class="talk_show" id="words">
      <p class="notice">
        <i class="iconfont speaker">&#xe713;</i>
        <span class="content">公告：<span class="text" id="notice-text"></span></span>
        <i id="close-iconfont" class="iconfont close">&#xe7cd;</i>
      </p>
      <div id="chat-box">
      </div>
    </div>
    <div class="talk_input">
      <input type="text" autoComplete="off" placeholder="请登录后发表评论" class="talk_word" id="talkwords">
      <input type="button" value="发送" class="talk_sub" id="talksub">
    </div>
  </div>
  <!--分享遮罩层开始-->
  <div id="mask2" class="">
    <span class="opacity"></span>
    <span class="cont"><img src="~/Content/LazyMainLine/img/share_tips.png" /></span>
  </div>

  <script src="~/Scripts/videojs7/video.min.js"></script>
  <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
  <script src='@(apiHost + "/signalr/hubs")'></script>

  <script>
    var live1Player;
    var isPause = true;
    var live1urlObj = {};
    var poster;
    $(function () {
      //ajax提交
      asyncPost = function (url, data, callback) {
        $.ajax({
          url: url,
          data: data,
          type: "post",
          xhrFields: {
            withCredentials: true
          },
          success: function (res) {
            callback(res)
          }
        })
      }
      var apiHost = '@apiHost';
      var curLiveCommentId = '';
      var liveId = "";
      var roomCode = GetUrlParameters("roomCode");
      function timeFormat(time) {
        var data = new Date(time);
        var year = data.getFullYear();  //获取年
        var month = data.getMonth() + 1;    //获取月
        var day = data.getDate(); //获取日
        var hours = data.getHours() < 10 ? '0' + data.getHours() : data.getHours();
        var minutes = data.getMinutes() < 10 ? '0' + data.getMinutes() : data.getMinutes();
        return month + "月" + day + "日" + hours + ":" + minutes;
      }
      //获取直播信息
      getLiveInfo()
      function getLiveInfo() {
        var url = apiHost + '/Students/LiveWs/Live'
        var data = {
          roomCode: roomCode
        }
        asyncPost(url, data, function (res) {
          if (res.IsSuccess) {
            if (res.Data.LiveStatus.Key == 1) {
              $('#LiveStatus').css({
                background: '#3A78E9',
                color: '#fff'
              })
            } else {
              $('#LiveStatus').css({
                background: '#fff',
                color: '#C2C2C2'
              })
            }
            $('#LiveStatus').html(res.Data.LiveStatus.Value);
            liveplayerStart(res.Data.Channel.HlsPullUrl, res.Data.LogoImage);
            $('#room-num').html(res.Data.LiveRoomCode);
            curLiveCommentId = res.Data.Comment.LiveCommentId;
            liveId = res.Data.LiveId;
            $('#hot').html(res.Data.OpData.HotCount);
            $('#like').html(res.Data.OpData.LikeCount);
            $('#forword').html(res.Data.OpData.ForwordCount);
            $('#title').html(res.Data.LiveName);
            $('#time').html(timeFormat(res.Data.LiveStartTime))
            $('.article-text').html(res.Data.Desc.Desc);
            $('#aHref').attr('href', res.Data.Desc.DescImageLink);
            $('#imgId').attr('src', res.Data.Desc.DescImage);
            $('#footId').html(res.Data.Desc.DescHintWord);
            if (res.Data.OpData.ShowHot) {
              $('#hotBox').show();
            } else {
              $('#hotBox').hide();
            };
            if (res.Data.OpData.ShowLike) {
              $('#addlike').show();
            } else {
              $('#addlike').hide();
            };
            if (res.Data.OpData.ShowForword) {
              $('#share').show();
            } else {
              $('#share').hide();
            };
          } else {
            dialogue.dlAlert(res.Msg);
          }
        })
      }
      //获取cookie
      function getCookie(name) {
        var arr, reg = new RegExp("(^| )*" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg)) {
          return unescape(arr[2]);
        } else { return null }
      }
      //添加cookie
      function addCookie(objName, objValue, objDays) {
        var str = objName + "=" + escape(objValue);
        if (objDays > 0) {
          var date = new Date();
          var ms = objDays * 24 * 3600 * 1000;
          date.setTime(date.getTime() + ms);
          str += "; expires=" + date.toGMTString();
        }
        if (objDays === Infinity) {
          str += "; expires=Fri, 31 Dec 9999 23:59:59 GMT";
        }

        str += "; path=/";
        document.cookie = str;
      };

      // 转发
      $("#share").on('click', function () {
        addforword();
        $("#mask2").show();
      });
      $("#mask2").click(function () {
        $("#mask2").hide();
      })
      function addforword() {
        if (getCookie("forworded" + $('#room-num').html())) {
          return
        }
        var url = apiHost + '/Students/LiveWs/Forword'
        var data = {
          liveId: liveId
        }
        asyncPost(url, data, function (res) {
          if (res.IsSuccess) {
            $('#forword').html(parseInt($('#forword').html(), 10) + 1)
            addCookie("forworded" + $('#room-num').html(), true, Infinity)
          }
        })
      };

      //点赞
      $('#addlike').on('click', function () {
        addlike();
      });
      function addlike() {
        if (getCookie("liked" + $('#room-num').html())) {
          return
        }
        var url = apiHost + '/Students/LiveWs/Like'
        var data = {
          liveId: liveId
        }
        asyncPost(url, data, function (res) {
          if (res.IsSuccess) {
            $('#like').html(parseInt($('#like').html(), 10) + 1)
            addCookie("liked" + $('#room-num').html(), true, Infinity)
          }
        })
      };
      // 是否登陆
      if ('@ViewBag.Student') {
        $('#talkwords').attr('placeholder', '请输入评论');
      } else {
        $('#talkwords').attr('placeholder', '请登录后发表评论');
      }
      $('.notice').css({
        display: 'none'
      });
      $('#chat-box').css({
        marginTop: '0'
      })
      // 关闭通知
      $("body").delegate('#close-iconfont', "click", function () {
        $('.notice').css({
          display: 'none'
        });
        $('#chat-box').css({
          marginTop: '0'
        })
      });

      var loginwxurl = '@(Html.Raw(ViewBag.LoginUrlOrigin))' + '&topBackUrl=' + location.href;
      //聊天接收历史消息
      function historyComments() {
        $.ajax({
          url: "@apiHost/Students/LiveWs/Comments",
          data: {
            commentId: curLiveCommentId,
            pageSize: 10 //显示最新的n条
          },
          type: "post",
          xhrFields: {
            withCredentials: true
          },
          success: function (result) {
            if (result.IsSuccess) {
              if (result.Data && result.Data.Notice && result.Data.Notice.Comment) {
                $('#notice-text').html(result.Data.Notice.Comment);
                $('.notice').css({
                  display: 'block'
                })
                $('#chat-box').css({
                  marginTop: '3.2rem'
                })
              } else {
                $('.notice').css({
                  display: 'none'
                })
                $('#chat-box').css({
                  marginTop: '0'
                })
              }

              $.map(result.Data.Comments, function (item) {
                insetHtml(item.CommentUserType, item.CommentUserName, item.Comment)
              })
            }
          }
        })
        //开启接收广播信息
        $.connection.hub.url = '@apiHost' + '/signalr'
        var curHub = $.connection.curHub
        curHub.client.notice = function (res) {
          //接收到信息的处理 CommentUserType  管理端的还没做，1是学生 2是管理员 然后CommentType是区分评论和公告 1是评论 2是公告
          console.log('resres', res)
          if (res.IsSuccess) {
            if (res.SiteType == 1) {
              // 评论
              insetHtml(res.Data.CommentUserType, res.Data.CommentUserName, res.Data.Comment)
            } else if (res.SiteType == 2) {
              // 公告
              $('#notice-text').html(res.Data.Comment);
              $('.notice').css({
                display: 'block'
              })
              $('#chat-box').css({
                marginTop: '3.2rem'
              })
            }
          }
        }
        $.connection.hub.start().done(function () {
          curHub.server.setRecGroup(curLiveCommentId)
        })
      };
      $('#talksub').click(function () {
        //发送单击，获取用户输入的数据value属性值
        var vals = $('#talkwords').val()
        if (vals == '') {
          dialogue.dlAlert('请输入数据！');
          return;
        }
        //如果输入的数据为空，则弹窗提示
        $.ajax({
          url: "@apiHost/Students/LiveWs/SendMsg",
          data: {
            commentId: curLiveCommentId,
            msg: vals
          },
          type: "post",
          xhrFields: {
            withCredentials: true
          },
          success: function (result) {
            if (result.IsSuccess) {
              // insetHtml(result.Data.Data.CommentUserType, result.Data.Data.CommentUserName, result.Data.Data.Comment)
            }
            else {
              if (result.ErrorCode == -1) {
                location.href = loginwxurl;
              } else {
                dialogue.dlAlert(result.Msg)
              }
            }
          }
        })
      })


      // 简介与互动动态显示
      $("#brief").on("click", function () {
        $("#brief").addClass('active-border');
        $("#interaction").removeClass('active-border');
        $('.article-padding').removeClass('display-none');
        $('.talk_con').addClass('display-none');
      });
      $("#interaction").on("click", function () {
        $("#interaction").addClass('active-border');
        $("#brief").removeClass('active-border');
        $('.talk_con').removeClass('display-none');
        $('.article-padding').addClass('display-none');
        historyComments()
      });

      // 聊天框
      var height = $('body').height() - $('#getHeight').height() - 20;
      $('#words').css({ 'height': height });
      $('.article-padding').css({ 'height': height });
      function insetHtml(from, name, vals) {
        var str = ""
        //选择A发送还是B发送
        str = '<div class="atalk"><span class="talk-name">' + name + '</span><span class="content">' + vals + '</span></div>'
        // if (from == 0) {
        //     str = '<div class="atalk"><span class="talk-name">'+name+'</span><span class="content">' + vals + '</span></div>'
        // } else {
        //     str = '<div class="btalk"><span class="talk-name">'+name+'</span><span class="content">' + vals + '</span></div>'
        // }
        //原有的内容+str,否则会覆盖掉原有内容
        $('#chat-box').html($('#chat-box').html() + str)
        //发送完数据后清空输入框
        $('#talkwords').val('')
        $("#words").scrollTop($("#words")[0].scrollHeight);
      }

      // videojs
      function liveplayerStart(url, LogoImage) {
        live1Player = videojs('liveplayer', {
          poster: '',
          controls: true,
          preload: 'auto',
          liveui: true,
          notSupportedMessage: '此视频暂时无法播放',
          controlBar: {
            remainingTimeDisplay: false,
            progressControl: false,
            pictureInPictureToggle: false,
          }
        }, function () {
          var that = this
          updateLiveVideo(url);
          this.poster(LogoImage); // 封面图片
          this.on('play', function () {
            // 播放
            videojs.log('play');
          })
          this.on('pause', function () {
            // 暂停
            videojs.log('pause');
          })
          $("#play").on("click", function () {
            that.play();
          });
          this.on('error', function (e) {
            // 报错
            videojs.log('error', e);
          })
          // this.on('loadedmetadata', function () {
          //     //加载到元数据后开始播放视频
          //     $("#myError").hide();
          //     startVideo();
          // })
        });
      }
      function updateLiveVideo(url) {
        if (url != null && url != '') {
          if (url.indexOf('rtmp') >= 0) {
            live1urlObj = { type: "rtmp/flv", src: url };
          }
          if (url.indexOf('m3u8') >= 0) {
            live1urlObj = { type: "application/x-mpegURL", src: url };
          }
          if (url.indexOf('flv') >= 0) {
            live1urlObj = { type: "video/x-flv", src: url };
          }
          if (url.indexOf('mp4') >= 0) {
            live1urlObj = { type: "video/mp4", src: url };
          }
          live1Player.src(live1urlObj);
        }
      };
      function playLive() {
        if (live1Player != null) {
          live1Player.src(live1urlObj);
          live1Player.play();
        }
      };

    });


  </script>