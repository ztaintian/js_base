@model CIIC.Hentai.Services.Dto.ViewModel.QuestionnaireViewModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>@Model.QueTitle - 预才网</title>
    <meta name="viewport" id="viewport" content="width=device-width, user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta name="screen-orientation" content="portrait/landscape">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">

    <link href="~/Content/reset.css" rel="stylesheet" />
    <link href="//at.alicdn.com/t/font_1155283_oqir07rxqd.css" rel="stylesheet" />
    <link href="~/Content/dialog.css" rel="stylesheet" />

    <script type="text/javascript" src="~/Scripts/jquery-mobile/jquery.1.11.1.min.js"></script>
    <script src="~/Scripts/controls.js"></script>
    <script type="text/javascript" src="~/Scripts/Common/SetSize.js"></script>
    <script type="text/javascript" src="~/Scripts/Common/baidu.js"></script>
    <script type="text/javascript" src="~/Scripts/Common/vue.min.js"></script>
    <script src="~/Scripts/jquery.scrollTo.min.js"></script>

    <style>
        body {
            background-color: #ffffff;
        }

        .header {
            width: 100%;
        }
        .header img {
            width: 100%;
        }
        .introduction {
            margin: 0.6rem;
            padding: 0.6rem;
            border-radius: 0.2rem;
            border: dashed 0.05rem #b5b5b5;
        }
        .introduction .title {
            font-size: 0.725rem;
            text-align: center;
            line-height: 1.28rem;
        }
        .introduction .content {
            font-size: 0.6rem;
            text-align: left;
            line-height: 1.28rem;
        }
        .form_div {
            padding: 0.6rem 1.17rem;
        }
        .form-inline {
            position: relative;
            margin-bottom: 1rem;
        }
        .form-inline span {
            font-size: 0.64rem;
            color: #333333;
            line-height: 1.7rem;
            font-weight: bold;
        }
        .form-inline span.important {
            color:#ff0000;
        }
        .form-inline .empty {
            height: 0.768rem;
            background-color: #ff4242;
            color: #ffffff;
            font-size: 0.554rem;
            position: absolute;
            right: 0;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            top: 0.4rem;
        }
        .form-inline.error .empty {
            display: block;
        }
        .form-inline i.option {
            position: absolute;
            right: .5rem;
            bottom: .55rem;
            font-size: .5rem;
            z-index: -1;
        }
        html input,
        html select,
        html textarea {
            border: solid 1px #afafaf;
            border-radius: 0.1rem;
            height: 1.7rem;
            width: 100%;
            box-sizing: border-box;
            padding: 0 0.8rem 0 0.1rem;
            color: #777777;
            font-size: 0.555rem;
            font-family: "微软雅黑","Microsoft YaHei";
        }
        html select {
            padding-left: 0.5rem;
            background-color: rgba(0,0,0,0);
        }
        html textarea {
            height: 5rem;
        }
        ul li {
            color: #777777;
            font-size: 0.555rem;
            padding: 0 1.2rem 0 0.5rem;
            border: solid 1px #afafaf;
            border-bottom: none;
            border-radius: 0.1rem;
            height: 1.7rem;
            line-height: 1.7rem;
            position: relative;
            display: flex;
        }
        ul.radiolist li i {
            position: absolute;
            right: 0.5rem;
            top: 0.1rem;
            display: none;
        }
        ul.radiolist li.active i {
            display: block;
        }
        ul.checkboxlist li i {
            position: absolute;
            right: 0.5rem;
            top: 0.1rem;
        }
        ul.checkboxlist li i.checkbox1 {
            display: block;
        }
        ul.checkboxlist li i.checkbox_selected {
            display: none;
        }
        ul.checkboxlist li.active i.checkbox1 {
            display: none;
        }
        ul.checkboxlist li.active i.checkbox_selected {
            display: block;
        }
        ul li:last-child {
            border-bottom: solid 1px #afafaf;
        }
        ul li input {
            border: none;
            /* position: absolute;
            width: 8rem; */
            flex: 1;
        }
        .submit {
            padding: 0 1.17rem 1.152rem;
        }
        .submit span {
            font-size: 0.555rem;
            color: #333333;
            text-align: left;
            display: block;
            margin-bottom: 0.7rem;
        }
        .submit button {
            width: 100%;
            height: 1.7rem;
            line-height: 1.7rem;
            border-radius: 0.2rem;
            text-align: center;
            color: #ffffff;
            font-size: 0.64rem;
        }

        .success {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            padding: 3.2rem 0;
            box-sizing: border-box;
            text-align: center;
            display: none;
            overflow-y: auto;
        }
        .success > div {
            position: relative;
        }
        .success p {
            font-size: 0.64rem;
            color: #777777;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }
            .success p.tel {
                position: absolute;
                top: 3.5rem;
                width: 11rem;
                margin-left: 5rem;
                text-align: left;
                color: #4e49a3;
                font-size: 0.74rem;
                font-weight: bold;
            }
                .success p.tel a {
                    color: #4e49a3;
                }
            .success p.tel2 {
                top: 5.92rem;
            }
            .success p > img {
                width: 1rem;
                margin-right: 0.2rem;
            }
        .success i {
            font-size: 7rem;
        }
        .success button {
            width: 90%;
            height: 1.7rem;
            line-height: 1.7rem;
            border-radius: 0.2rem;
            text-align: center;
            color: #ffffff;
            font-size: 0.64rem;
            margin: 3rem 0.6rem 0 0.6rem;
        }
        .success img {
            width: 100%;
        }

        [v-cloak] {
            display: none
        }
        .text-area{
            border: solid 1px #afafaf;
            border-radius: 0.1rem;
            width: 100%;
            box-sizing: border-box;
            padding: 0.2rem 0.5rem;
            color: #777777;
            font-size: 0.555rem;
        }
    </style>
</head>
<body>
    <div id="vueApp" v-cloak>

        <!-- 内容页面 -->
        <div class="baoming">
            <div v-if="obj.TopImg" class="header">
                <img :src="obj.TopImg" />
                <!-- <img src="~/Content/OnLineJobFairEnterpriseRegistration/header.png" /> -->
            </div>
            <div class="introduction" v-if="obj.Content != '' && obj.Content != null">
                <!--<div class="title" :style="{color: obj.ColorNumber}">{{obj.QueTitle}}</div>-->
                <div class="content" :style="{color: obj.ColorNumber}" v-html="obj.Content">

                </div>
            </div>
            <div class="form_div">
                <template v-for="(item,index) in dataList">
                    <!-- 0:填空;1:单项选;2:多项选;3:下拉;4:多行文本; -->
                    <!-- 填空 -->
                    <div class="form-inline" type="text" key="key1" v-if="item.SubjectType==0">
                        <div><span class="important" v-if="item.IsRequired">*</span><span :id="'scroll'+index">{{item.Subject}}</span></div>
                        <div class="empty" v-if="item.errorFlag">该项为必填项</div>
                        <input style="padding-left:0.5rem;" v-model="item.value" placeholder="请输入" />
                    </div>

                    <!-- 单项选 -->
                    <div class="form-inline" type="radio" key="key2" v-if="item.SubjectType==1">
                        <div><span class="important" v-if="item.IsRequired">*</span><span :id="'scroll'+index">{{item.Subject}}</span></div>
                        <div class="empty" v-if="item.errorFlag">{{item.tip}}</div>
                        <ul class="radiolist">
                            <li v-for="(itemChild,indexChild) in item.OptValue" :class="itemChild.activeFlag?'active':''" v-on:click="radioSelect(item,itemChild)">
                                <div style="display:inline-block;">{{String.fromCharCode(64 + parseInt(indexChild+1))}}、<span class="important" v-if="itemChild.IsRequired&&itemChild.activeFlag">*</span>{{itemChild.Text}}</div>
                                <template v-if="itemChild.IsText">
                                    ：
                                    <input v-model="itemChild.value" placeholder="请自己填写" />
                                </template>
                                <i class="iconfont radio" :style="{color: obj.ColorNumber}"></i>
                            </li>
                        </ul>
                    </div>

                    <!-- 多项选 -->
                    <div class="form-inline" type="checkbox" key="key4" v-if="item.SubjectType==2">
                        <div><span class="important" v-if="item.IsRequired">*</span><span :id="'scroll'+index">{{item.Subject}}</span><span style="font-size:13px;">【最多选择2项】</span></div>
                        <div class="empty" v-if="item.errorFlag">{{item.tip}}</div>
                        <ul class="checkboxlist">
                            <li v-for="(itemChild,indexChild) in item.OptValue" :class="itemChild.activeFlag?'active':''" v-on:click="multipleChoice(item,itemChild,$event)"> <div style="display:inline-block;">{{String.fromCharCode(64 + parseInt(indexChild+1))}}、<span class="important" v-if="itemChild.IsRequired&&itemChild.activeFlag">*</span>{{itemChild.Text}}</div>
                            <template v-if="itemChild.IsText">
                                ：
                                <input v-model="itemChild.value" placeholder="请自己填写" />
                            </template>
                            <i class="iconfont checkbox1" :style="{color: obj.ColorNumber}"></i><i class="iconfont checkbox_selected" :style="{color: obj.ColorNumber}"></i></li>
                        </ul>
                    </div>

                    <!-- 下拉 -->
                    <div class="form-inline" type="select" key="key3" v-if="item.SubjectType==3">
                        <div><span class="important" v-if="item.IsRequired">*</span><span :id="'scroll'+index">{{item.Subject}}</span></div>
                        <div class="empty" v-if="item.errorFlag">该项为必选项</div>
                        <i class="iconfont option" :style="{color: obj.ColorNumber}"></i>
                        <select v-model="item.value">
                            <option value="">请选择</option>
                            <option v-for="(itemChild,indexChild) in item.OptValue" :value="itemChild.Text">{{itemChild.Text}}</option>
                        </select>
                    </div>

                    <!-- 多行文本 -->
                    <div class="form-inline" type="text" key="key1" v-if="item.SubjectType==4">
                        <div><span class="important" v-if="item.IsRequired">*</span><span :id="'scroll'+index">{{item.Subject}}</span></div>
                        <div class="empty" v-if="item.errorFlag">该项为必填项</div>
                        <textarea rows="4" v-model="item.value" placeholder="请输入" class="text-area"></textarea>
                    </div>

                </template>
            </div>
            <div class="submit">
                <span :style="{color: obj.ColorNumber}" v-html="obj.Ending"></span>
                <button :style="{backgroundColor: obj.ColorNumber}" v-on:click="signUp">提交</button>
            </div>
        </div>

        <!-- 结果页面 -->
        <div class="success" id="result">
            <i class="iconfont radio" :style="{color: obj.ColorNumber}"></i>
            <p v-html="obj.ResultText"></p>
            <div>
                <img :src="obj.ResultImg" />
                <p class="tel"><a :href="'tel:'+obj.ResultContact" :style="{color: obj.ColorNumber}">{{obj.ResultContact}}</a></p>
                <p class="tel tel2"><a :href="'tel:'+obj.ResultSecondContact" :style="{color: obj.ColorNumber}">{{obj.ResultSecondContact}}</a></p>
            </div>
            <button :style="{backgroundColor: obj.ColorNumber}" v-if="obj.ResultType===1" v-on:click="resultJump">{{obj.ResultButText}}</button>
        </div>

        <!-- 结束页面 -->
        <div class="success" id="end">
            <i class="iconfont radio" :style="{color: obj.ColorNumber}"></i>
            <p v-html="obj.EndText"></p>
            <div>
                <img :src="obj.EndImg" />
                <p class="tel"><a :href="'tel:'+obj.EndContact" :style="{color: obj.ColorNumber}">{{obj.EndContact}}</a></p>
                <p class="tel tel2"><a :href="'tel:'+obj.EndSecondContact" :style="{color: obj.ColorNumber}">{{obj.EndSecondContact}}</a></p>
            </div>
            <button :style="{backgroundColor: obj.ColorNumber}" v-if="obj.EndType===1" v-on:click="endJump">{{obj.EndButText}}</button>
        </div>

    </div>
    <script>
        var app = new Vue({
            el: '#vueApp',
            data() {
                return {
                    dataList: [],
                    obj: {
                        ColorNumber: "",
                        Content: null,
                        EndButText: null,
                        EndButUrl: null,
                        EndText: "",
                        EndTime: "",
                        EndType: 0,
                        Ending: null,
                        EndContact: "",
                        EndSecondContact: "",
                        EndImg: "",
                        QueCode: "",
                        QueId: "",
                        QueTitle: "",
                        ResultButText: null,
                        ResultButUrl: null,
                        ResultText: "",
                        ResultType: 0,
                        ResultContact: "",
                        ResultSecondContact: "",
                        ResultImg: "",
                        StartTime: "",
                        TopImg: null,
                        WXLogo: null,
                        WXShareContent: null,
                        WXShareTitle: null,
                        Subject: []
                    }
                }
            },
            mounted() {
                    // dialogue.dlAlert({
                    //     title: '温馨提示',
                    //     content: '',
                    //     btns: [{
                    //         text: '接受',
                    //         class: 'btn1',
                    //         fn: function () {
                    //             buildCard(function (res) {
                    //                 if (res.IsSuccess) {
                    //                     // that.isBuildCard = true;
                    //                 }
                    //             });
                    //             dialogue.closeAll();
                    //         }
                    //     }]
                    // });

                var question = eval(@Html.Raw(CIIC.Common.SerializeHelper.JsonSerialize(Model)));
                $.extend(true, this.obj, question);
                console.log('question', question)
                if (this.obj.OutTime) {
                    $('body').css('overflow', 'hidden');
                    $('.baoming').hide();
                    $('#result').hide();
                    $('#end').show();
                    return;
                }
                this.obj.ColorNumber = question.ColorNumber;
                if (question.Subject.length > 0) {
                    question.Subject.map(function(item){
                        item.value = '';
                        item.errorFlag = false;
                        item.tip = '该项为必选项';
                        if ($.isArray(item.OptValue) && item.OptValue.length > 0) {
                            item.OptValue.map(function (itemC) {
                                itemC.activeFlag = false;
                                itemC.value = '';
                            })
                        }
                    })
                    this.dataList = question.Subject;
                } 
            },
            methods: {
                resultJump: function () {
                    window.location.href = this.obj.ResultButUrl;
                },
                endJump: function () {
                    window.location.href = this.obj.EndButUrl;
                },
                radioSelect(item,itemChild,index) {
                    // 单选
                    item.OptValue.map(function(value) {
                        value.activeFlag = false;
                    })
                    itemChild.activeFlag = !itemChild.activeFlag;
                },
                multipleChoice(item,itemChild,e) {
                    // 多选
                    //if (e.target.nodeName.toLowerCase() === 'input') {
                    //    return;
                    //}
                    var selectnum = 0;
                    item.OptValue.map(function(value) {
                        if (value.activeFlag) {
                            selectnum++
                        }
                    })
                    if (itemChild.activeFlag) {
                        itemChild.activeFlag=!itemChild.activeFlag;
                        return;
                    }
                    if (selectnum>=1) {
                        alert('此项最多只能选择1项！')
                        return;
                    }
                    itemChild.activeFlag=!itemChild.activeFlag;
                },
                signUp() {
                    // 报名参加
                    var that = this;
                    var id = '';
                    this.dataList.map(function(value) {
                        // 单选项
                        if (value.SubjectType == 1) {
                            value.OptValue.some((item) => {
                                if (item.activeFlag) {
                                    if (item.IsText) {
                                       value.value = item.value?item.Text+'§'+item.value:item.Text;
                                    } else {
                                        value.value = item.Text;
                                    }
                                    return true;
                                }
                            })
                        } else if (value.SubjectType == 2) { // 多选
                            var arr =[];
                            value.OptValue.map(function (item) {
                                if (item.activeFlag) {
                                    if (item.IsText) {
                                        item.value?arr.push(item.Text+'§'+item.value):arr.push(item.Text);
                                    } else {
                                        arr.push(item.Text);
                                    }
                                }
                            });
                            value.value = arr.join('¤');
                        }
                        if (value.IsRequired && !value.value) {
                            value.errorFlag = true;
                        } else {
                            value.errorFlag = false;
                        }
                        var emptyReg = /^\s*$/g;
                        if (!value.errorFlag) {
                            if ($.isArray(value.OptValue) && value.OptValue.length > 0) {
                                value.OptValue.some(function (itemC) {
                                    if (itemC.activeFlag && itemC.IsText && itemC.IsRequired && emptyReg.test(itemC.value)) {
                                        value.errorFlag = true; 
                                        value.tip = '该项为必填项';
                                        return true;
                                    } else {
                                        value.errorFlag = false;  
                                    }
                                })
                            }
                        }
                    })
                    this.dataList.some(function(value,index) {
                        if (value.errorFlag) {
                            id = 'scroll' + index;
                            return true;
                        }
                    })
                    if (id) {
                        document.getElementById(id).scrollIntoView(true)
                    } else {

                        //$('body').css('overflow', 'hidden');
                        //$('.baoming').hide();
                        //$('#end').show();
                        //$('.success').show();

                        $.ajax({
                            type: "POST",
                            url: '/Questionnaire/SubQue',
                            data: {
                                QueId: this.obj.QueId,
                                Subject: this.dataList
                            },
                            dataType: 'json',
                            timeout: 30000,
                            xhrFields: {
                                withCredentials: true // 这里设置了withCredentials
                            },
                            success: function (message) {
                                if (message.IsSuccess) {
                                    $('body').css('overflow', 'hidden');
                                    $('.baoming').hide();
                                    $('#end').hide();
                                    $('#result').show();
                                } else {
                                    alert(message.Msg);
                                }
                            },
                            error: function (xhr, type, error) {
                            }
                        });
                    }
                }
            }
        })
    </script>

    <script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
    <script src="/Scripts/SDKShare.js"></script>
    <script>
        @{
           CIIC.Hentai.Services.Weixins.WX_JsParasPublic WXjsParasPublic = ViewBag.WXjsParasPublic;
        }
        var ispublic = @(WXjsParasPublic.IsPublic);

        if(ispublic==1)
        {
            var weixinShare = new WeixinShare({
                title: '@(WXjsParasPublic.title)',
                content: '@(WXjsParasPublic.content)',
                linkUrl: '@(WXjsParasPublic.linkUrl)',
                imgUrl: '@(WXjsParasPublic.imgUrl)',
                appId: '@WXjsParasPublic.JsParas.appId',
                debug: false,
                timestamp: '@WXjsParasPublic.JsParas.timestamp',
                nonceStr: '@WXjsParasPublic.JsParas.nonceStr',
                signature: '@WXjsParasPublic.JsParas.signature',
                shareAppMessageSuccessCallback: function () {
                    @(Html.Raw(WXjsParasPublic.Callback1))
                },
                shareTimelineSuccessCallback: function () {
                    @(Html.Raw(WXjsParasPublic.Callback1))
                },
                shareQQSuccessCallback: function () {
                    @(Html.Raw(WXjsParasPublic.Callback1))
                },
                shareWeiboSuccessCallback: function () {
                    @(Html.Raw(WXjsParasPublic.Callback1))
                },
                voiceRecordEndCallback: function (param) {
                    if (recAutoStop != null) {
                        recAutoStop(param);
                    }
                }
            });
        }
    </script>
</body>
</html>